name: AIæƒ…å ±åé›†ã¨æ›´æ–°

on:
  schedule:
    # æ—¥æœ¬æ™‚é–“ã§6æ™‚é–“ã”ã¨ã«å®Ÿè¡Œ (0æ™‚ã€6æ™‚ã€12æ™‚ã€18æ™‚)
    - cron: '0 15,21,3,9 * * *'  # UTCã§è¨­å®šï¼ˆæ—¥æœ¬æ™‚é–“-9æ™‚é–“ï¼‰
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

env:
  NODE_VERSION: '20'

jobs:
  collect-and-update:
    runs-on: ubuntu-latest
    
    steps:
      # ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # Node.jsã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install dependencies
        run: npm ci

      # ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
      - name: Set up environment
        run: |
          echo "COLLECTION_RUN_ID=${{ github.run_id }}" >> $GITHUB_ENV
          echo "COLLECTION_TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_ENV

      # AIæƒ…å ±ã‚µã‚¤ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿åé›†
      - name: Collect AI news and tools
        id: collect
        run: |
          # åé›†ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œ
          node scripts/collect-ai-info.js
        continue-on-error: true

      # åé›†çµæœã®å‡¦ç†ã¨ç¿»è¨³
      - name: Process and translate content
        if: steps.collect.outcome == 'success'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # ç¿»è¨³ã¨è¦ç´„å‡¦ç†ï¼ˆClaude APIä½¿ç”¨ï¼‰
          node scripts/translate-and-summarize.js

      # åé›†ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜
      - name: Save collected data
        if: steps.collect.outcome == 'success'
        run: |
          # ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã®æ›´æ–°
          node scripts/save-collected-data.js

      # å¤‰æ›´ã®ã‚³ãƒŸãƒƒãƒˆã¨ãƒ—ãƒƒã‚·ãƒ¥
      - name: Commit and push changes
        if: steps.collect.outcome == 'success'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # å¤‰æ›´ãŒã‚ã‚‹å ´åˆã®ã¿ã‚³ãƒŸãƒƒãƒˆ
          if [ -n "$(git status --porcelain)" ]; then
            git add -A
            git commit -m "ğŸ¤– è‡ªå‹•æ›´æ–°: AIæƒ…å ±åé›† $(date +%Y-%m-%d_%H:%M)"
            git push
          else
            echo "No changes to commit"
          fi

      # Vercelã¸ã®è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ãƒˆãƒªã‚¬ãƒ¼ï¼ˆWebhookã‚’ä½¿ç”¨ï¼‰
      - name: Trigger Vercel deployment
        if: steps.collect.outcome == 'success'
        run: |
          if [ -n "${{ secrets.VERCEL_DEPLOY_HOOK }}" ]; then
            curl -X POST ${{ secrets.VERCEL_DEPLOY_HOOK }}
          fi

      # Slackã¸ã®é€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
      - name: Notify Slack
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            STATUS="${{ steps.collect.outcome }}"
            COLOR="good"
            if [ "$STATUS" != "success" ]; then COLOR="danger"; fi
            
            curl -X POST -H 'Content-type: application/json' \
              --data "{
                \"attachments\": [{
                  \"color\": \"$COLOR\",
                  \"title\": \"AIæƒ…å ±åé›†çµæœ\",
                  \"text\": \"ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: $STATUS\",
                  \"footer\": \"Run ID: ${{ github.run_id }}\",
                  \"ts\": $(date +%s)
                }]
              }" \
              $SLACK_WEBHOOK_URL
          fi

      # ã‚¨ãƒ©ãƒ¼æ™‚ã®è©³ç´°ãƒ­ã‚°
      - name: Upload error logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: error-logs
          path: |
            logs/
            *.log

  # é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆï¼ˆæ¯é€±æœˆæ›œæ—¥ï¼‰
  weekly-report:
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 0 * * 1'  # æœˆæ›œæ—¥ã®ã¿
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci

      - name: Generate weekly report
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          node scripts/generate-weekly-report.js

      - name: Commit report
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -A
          git commit -m "ğŸ“Š é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ: $(date +%Y-%m-%d)"
          git push