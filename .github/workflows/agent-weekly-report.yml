name: Weekly Agent Report

on:
  schedule:
    # æ¯é€±æœˆæ›œæ—¥ã®æ—¥æœ¬æ™‚é–“æœ9æ™‚ã«å®Ÿè¡Œ
    - cron: '0 0 * * MON'  # UTC 0:00 Monday = JST 9:00 Monday
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  weekly-report:
    name: Generate Weekly Report
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          npm ci
          npm install -g ts-node typescript
          npm install js-yaml
      
      - name: Generate weekly report
        run: |
          echo "ğŸ“… é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆé–‹å§‹"
          ts-node agents/research/scripts/generate_report.ts
      
      - name: Create pull request
        id: create_pr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'ğŸ“Š Weekly Agent Report - Week of ${{ env.WEEK_START }}'
          title: 'ğŸ“Š é€±æ¬¡AIãƒ„ãƒ¼ãƒ«æ›´æ–°ãƒ¬ãƒãƒ¼ãƒˆ - ${{ env.WEEK_START }}'
          body: |
            ## é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ
            
            ã“ã®PRã«ã¯ä»Šé€±ã®AIãƒ„ãƒ¼ãƒ«æ›´æ–°æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚
            
            ### å«ã¾ã‚Œã‚‹å†…å®¹
            - å„ãƒ„ãƒ¼ãƒ«ã®æ›´æ–°ã‚µãƒãƒªãƒ¼
            - é‡è¦ãªå¤‰æ›´ç‚¹ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            - æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
            
            ### ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒã‚¤ãƒ³ãƒˆ
            - [ ] æ›´æ–°å†…å®¹ã®ç¢ºèª
            - [ ] æ—¥æœ¬èªã®è¡¨ç¾ãƒã‚§ãƒƒã‚¯
            - [ ] ãƒªãƒ³ã‚¯ã®æœ‰åŠ¹æ€§ç¢ºèª
            
            ---
            *ã“ã®PRã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*
          branch: weekly-report-${{ env.WEEK_START }}
          delete-branch: true
          labels: |
            documentation
            auto-generated
            weekly-report
      
      - name: Enable auto-merge
        if: steps.create_pr.outputs.pull-request-number
        run: |
          gh pr merge --auto --squash "${{ steps.create_pr.outputs.pull-request-number }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Summary
        run: |
          echo "# é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- PRç•ªå·: #${{ steps.create_pr.outputs.pull-request-number }}" >> $GITHUB_STEP_SUMMARY
          echo "- ãƒ–ãƒ©ãƒ³ãƒ: weekly-report-${{ env.WEEK_START }}" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "docs/updates/weekly-report-$(date +%Y-%m-%d).md" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## ãƒ¬ãƒãƒ¼ãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼" >> $GITHUB_STEP_SUMMARY
            head -n 30 "docs/updates/weekly-report-$(date +%Y-%m-%d).md" >> $GITHUB_STEP_SUMMARY
          fi
    
    env:
      WEEK_START: ${{ steps.get_week.outputs.week_start }}

  content-generation:
    name: Generate Content Suggestions
    runs-on: ubuntu-latest
    needs: weekly-report
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Analyze trends
        run: |
          echo "ğŸ“ˆ ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æä¸­..."
          # ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œï¼ˆå®Ÿè£…äºˆå®šï¼‰
      
      - name: Generate content ideas
        run: |
          echo "ğŸ’¡ ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¢ã‚¤ãƒ‡ã‚¢ç”Ÿæˆ"
          
          cat << EOF > content-ideas.md
          # ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ææ¡ˆ - $(date +%Y-%m-%d)
          
          ## ä»Šé€±ã®ãƒˆãƒ¬ãƒ³ãƒ‰ã«åŸºã¥ãè¨˜äº‹æ¡ˆ
          
          1. **åˆå¿ƒè€…å‘ã‘ã‚¬ã‚¤ãƒ‰**
             - ã‚¿ã‚¤ãƒˆãƒ«æ¡ˆ: ã€Œä»Šé€±ãƒªãƒªãƒ¼ã‚¹ã•ã‚ŒãŸæ–°æ©Ÿèƒ½ã‚’ä½¿ã£ã¦ã¿ã‚ˆã†ã€
             - å¯¾è±¡: éã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢
             - æ¨å®šèª­äº†æ™‚é–“: 5åˆ†
          
          2. **æ¯”è¼ƒè¨˜äº‹**
             - ã‚¿ã‚¤ãƒˆãƒ«æ¡ˆ: ã€Œä¾¡æ ¼æ”¹å®šå¾Œã®ãƒ„ãƒ¼ãƒ«æ¯”è¼ƒã€
             - å¯¾è±¡: ã‚³ã‚¹ãƒˆé‡è¦–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼
             - æ¨å®šèª­äº†æ™‚é–“: 10åˆ†
          
          3. **æŠ€è¡“è§£èª¬**
             - ã‚¿ã‚¤ãƒˆãƒ«æ¡ˆ: ã€Œæ–°APIã®æ´»ç”¨æ–¹æ³•ã€
             - å¯¾è±¡: é–‹ç™ºè€…
             - æ¨å®šèª­äº†æ™‚é–“: 15åˆ†
          EOF
      
      - name: Create content issue
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: 'ğŸ“ é€±æ¬¡ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ææ¡ˆ - ${{ env.CURRENT_WEEK }}'
          content-filepath: ./content-ideas.md
          labels: |
            content
            suggestion
            weekly
    
    env:
      CURRENT_WEEK: 'Week of ${{ steps.get_week.outputs.week_start }}'